# etcd

etcd 是一个同于配置共享和服务发现的键值存储系统。归根结底是一个存储组件，且可以实现配置共享和服务发现。满足了 CAP（一致性，可用性，分区容错）中的CP。

## etcd 中常用的术语

| 术语| 描述 | 备注 |
| --------------- | --------------- | --------------- |
|Raft| Raft算法，etcd实现一致性的核心 | etcd有etcd-raft模块 |
|Follower|Raft中的从属节点|竞争leader失败|
|Leader|Raft中的领导节点，用于处理数据提交|Leader节点协调整个集群|
|Candidate|候选节点|当Follower接收Leader节点的消息超时会转变为Candidate|
|Node|Raft状态机的实例|Raft中涉及多个节点|
|Member|etcd实例，管理着对应的Node节点|可处理客户端请求|
|Peer|同一个集群中的另一个Member|其他成员|
|Cluster|etcd集群|拥有多个etcd member|
|Lease|租期|关键设置的租期，过期删除|
|Watch|检测机制|监控键值的变化|
|Term|任期|某个节点成为Leader，到下一次竞选的时间|
|WAL|预写式日志|用于持久化存储的日志格式|
|Client|客户端|向etcd发起请求的客户端|

## etcd 的应用场景

- 键值对存储：etcd 是一个用于键值对存储的组件，存储是 etcd 最基本的功能
- 服务注册与发现：etcd 基于 Raft 算法能够有力地保证分布式场景中的一致性
- 消息发布与订阅
- 分布式锁

## etcd 核心架构

![etcd 核心架构图](../../assets/etcd.drawio.png)

## etcd-raft

1. 发起选举，只有在 Candidate 或者 Follower 状态下的节点才有可能发起一个选举流程。
1. 节点启动都以 Follower 启动，同时随机生成自己的选举超时时间。

2. 参与选举

## etcd 事务

- 原子性：要么全部成功，要么全部失败
- 一致性：要满足完整性约束
- 持久性：事务一旦提交，对于数据库的修改应该是永久的
- 隔离性：事务之间隔离

### etcd 事务隔离级别

- 读未提交：能够读取到其他事务中还未提交的数据，这可能导致**脏读**的问题
- 读已提交：只能读到已经提交的数据，即别的事务提交后，当前事务就能读取到被修改的数据，这可能导致**不可重复读**的问题
- 可重复读：一个事务中，同一个读操作在事务的任意时刻都能得到相同的结果，其他事务的提交操作对本事务不会产生影响。
- 串行化：串行化执行事务

etcd 中最低的隔离级别是 **读已提交**

## etcd 分布式锁

### 基于数据库实现的分布式锁

基于数据库表的增删，当需要锁住某个方法时，往该表中插入一条相关的记录，该方法必须有**唯一性约束**
基于数据库的排他锁

### 基于 ZooKeeper 实现分布式锁

申请对某个方法加锁时，在 ZooKeeper 上与该方法的指定节点的目录下，生成一个唯一的临时有序节点

### 基于缓存实现的分布式锁

etcd：

1. 客户端初始化与 etcd 服务建立连接
2. 创建租约，自动续约
3. 创建事务，获取锁
4. 执行业务逻辑，最后释放锁

## etcd 服务注册与发现

服务注册：服务实例启动时，将自身的信息注册到服务注册与发现中心，并在运行时通过心跳等方式发送自己的状态
服务发现：从服务注册与发现中心，获取其他服务的信息用于远程调用

服务注册与发现中心主要是管理当前注册到服务注册与发现中心的微服务实例元数据信息，
包括服务实例的服务名，IP 地址，端口号，服务描述和服务状态等

与注册到服务注册与发现中心的微服务实例维持心跳，定期检查注册表中的服务实例是否在线，并剔除掉无效的服务实例信息

提供服务发现能力，为服务调用方提供服务提供方的服务实例元数据
